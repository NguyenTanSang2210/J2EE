<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh To√°n QR - ƒê∆°n H√†ng #<span th:text="${invoice.id}"></span></title>
    <th:block th:replace="~{layout :: link-css}"></th:block>
    <th:block th:replace="~{layout::custom-css}"></th:block>
    <th:block th:replace="~{layout::icons-and-fonts}"></th:block>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }
        .payment-container {
            max-width: 600px;
            margin: 0 auto;
        }
        .payment-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .payment-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        .payment-header h2 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: bold;
        }
        .payment-header p {
            margin: 0.5rem 0 0;
            opacity: 0.9;
        }
        .qr-section {
            padding: 2rem;
            text-align: center;
            background: #f8f9fa;
        }
        .qr-code-wrapper {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: inline-block;
            margin-bottom: 1rem;
        }
        .qr-code-wrapper img {
            max-width: 300px;
            height: auto;
            border-radius: 10px;
        }
        .payment-info {
            padding: 2rem;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e9ecef;
        }
        .info-row:last-child {
            border-bottom: none;
        }
        .info-label {
            font-weight: 600;
            color: #6c757d;
        }
        .info-value {
            font-weight: 500;
            color: #212529;
        }
        .info-value.amount {
            font-size: 1.5rem;
            color: #667eea;
            font-weight: bold;
        }
        .highlight-box {
            background: #fff3cd;
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid #ffc107;
            margin: 0.5rem 0;
        }
        .transfer-content {
            color: #dc3545;
            font-family: monospace;
            font-size: 1.2em;
            font-weight: bold;
        }
        .status-section {
            padding: 1.5rem 2rem;
            background: #fff3cd;
            border-top: 2px solid #ffc107;
            text-align: center;
        }
        .status-section.paid {
            background: #d4edda;
            border-top-color: #28a745;
        }
        .status-icon {
            font-size: 3rem;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .status-text {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        .action-buttons {
            padding: 1.5rem 2rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        .btn-custom {
            padding: 0.75rem 2rem;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-cancel {
            background: #dc3545;
            color: white;
            border: none;
        }
        .btn-cancel:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        .instructions {
            padding: 1.5rem 2rem;
            background: #e7f3ff;
            border-left: 4px solid #667eea;
        }
        .instructions h5 {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        .instructions ol {
            margin: 0;
            padding-left: 1.5rem;
        }
        .instructions li {
            margin-bottom: 0.5rem;
        }
        .spinner-border {
            width: 1.2rem;
            height: 1.2rem;
            border-width: 2px;
        }
    </style>
</head>
<body>
<th:block th:replace="~{layout :: header}"></th:block>

<div class="container payment-container">
    <div class="payment-card">
        <!-- Header -->
        <div class="payment-header">
            <h2>
                <i class="bi bi-qr-code me-2"></i>Thanh To√°n QR Code
            </h2>
            <p>ƒê∆°n h√†ng #<span th:text="${invoice.id}"></span></p>
        </div>

        <!-- QR Code Section -->
        <div class="qr-section">
            <div class="qr-code-wrapper">
                <img th:src="${qrCode.qrDataURL}" 
                     alt="QR Code Thanh To√°n" 
                     id="qrCodeImage"
                     onerror="this.style.display='none'; document.getElementById('qr-fallback').style.display='block';">
                <div id="qr-fallback" style="display: none; padding: 30px; text-align: center;">
                    <i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: #ffc107;"></i>
                    <p style="margin-top: 15px; color: #666; font-weight: 600;">
                        ‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i m√£ QR ƒë·ªông
                    </p>
                    <p style="color: #999;">
                        Vui l√≤ng nh·∫≠p th√¥ng tin chuy·ªÉn kho·∫£n th·ªß c√¥ng b√™n d∆∞·ªõi<br>
                        S·ª≠ d·ª•ng n√∫t <strong>Copy</strong> ƒë·ªÉ d·ªÖ d√†ng sao ch√©p th√¥ng tin
                    </p>
                </div>
            </div>
            <p class="text-muted mb-0">
                <i class="bi bi-phone me-1"></i>Qu√©t m√£ QR b·∫±ng ·ª©ng d·ª•ng ng√¢n h√†ng
            </p>
        </div>

        <!-- Payment Info -->
        <div class="payment-info">
            <!-- Bank Name -->
            <div class="info-row">
                <span class="info-label">
                    <i class="bi bi-bank me-1"></i>Ng√¢n h√†ng:
                </span>
                <span class="info-value" th:text="${qrCode.bankName}">TPBank</span>
            </div>

            <!-- Account Number -->
            <div class="info-row">
                <span class="info-label">
                    <i class="bi bi-credit-card me-1"></i>S·ªë t√†i kho·∫£n:
                </span>
                <span class="info-value">
                    <span th:text="${qrCode.accountNumber}">35322102904</span>
                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="copyToClipboard(this, document.getElementById('account-copy').textContent)" style="font-size: 0.75rem;">
                        <i class="bi bi-clipboard"></i> Copy
                    </button>
                    <span id="account-copy" style="display: none;" th:text="${qrCode.accountNumber}"></span>
                </span>
            </div>

            <!-- Transfer Content - Highlighted -->
            <div class="highlight-box">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span class="info-label">
                        <i class="bi bi-chat-square-text me-1"></i>N·ªôi dung chuy·ªÉn kho·∫£n:
                    </span>
                    <button class="btn btn-sm btn-danger" onclick="copyToClipboard(this, document.getElementById('content-copy').textContent)" style="font-size: 0.75rem;">
                        <i class="bi bi-clipboard-check"></i> Copy
                    </button>
                </div>
                <div class="transfer-content" th:text="${qrCode.content}">ORDER_17</div>
                <span id="content-copy" style="display: none;" th:text="${qrCode.content}"></span>
                <div style="margin-top: 8px; font-size: 0.85em; color: #856404;">
                    <i class="bi bi-exclamation-triangle-fill me-1"></i>
                    <strong>L∆ØU √ù:</strong> N·ªôi dung chuy·ªÉn kho·∫£n ph·∫£i ch√≠nh x√°c ƒë·ªÉ h·ªá th·ªëng t·ª± ƒë·ªông x√°c nh·∫≠n!
                </div>
            </div>

            <!-- Amount -->
            <div class="info-row" style="border-top: 2px solid #667eea; margin-top: 1rem; padding-top: 1rem;">
                <span class="info-label">
                    <i class="bi bi-cash-stack me-1"></i>S·ªë ti·ªÅn:
                </span>
                <span style="display: flex; align-items: center; gap: 10px;">
                    <span class="info-value amount">
                        <span th:text="${#numbers.formatDecimal(qrCode.amount, 0, 'COMMA', 0, 'POINT')}">100,000</span> ƒë
                    </span>
                    <button class="btn btn-sm btn-outline-success" onclick="copyToClipboard(this, document.getElementById('amount-copy').textContent)" style="font-size: 0.75rem;">
                        <i class="bi bi-clipboard"></i> Copy
                    </button>
                    <span id="amount-copy" style="display: none;" th:text="${qrCode.amount}"></span>
                </span>
            </div>
        </div>

        <!-- Status Section -->
        <div class="status-section" id="statusSection">
            <div class="status-icon">
                <span class="spinner-border text-warning" role="status"></span>
            </div>
            <div class="status-text text-warning" id="statusText">
                <i class="bi bi-hourglass-split me-2"></i>ƒêang ch·ªù thanh to√°n...
            </div>
            <small class="text-muted d-block mt-2" id="checkingText">
                H·ªá th·ªëng ƒëang ki·ªÉm tra giao d·ªãch...
            </small>
        </div>

        <!-- Instructions -->
        <div class="instructions">
            <h5><i class="bi bi-info-circle me-2"></i>H∆∞·ªõng d·∫´n thanh to√°n</h5>
            <ol>
                <li>M·ªü ·ª©ng d·ª•ng ng√¢n h√†ng tr√™n ƒëi·ªán tho·∫°i</li>
                <li>Ch·ªçn ch·ª©c nƒÉng <strong>Qu√©t m√£ QR</strong></li>
                <li>Qu√©t m√£ QR ph√≠a tr√™n</li>
                <li>Ki·ªÉm tra th√¥ng tin v√† x√°c nh·∫≠n chuy·ªÉn kho·∫£n</li>
                <li>H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông x√°c nh·∫≠n sau khi nh·∫≠n ƒë∆∞·ª£c ti·ªÅn</li>
            </ol>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons" id="actionButtons">
            <button type="button" class="btn btn-success btn-custom" onclick="verifyManually()" id="manualVerifyBtn" style="background: #28a745; color: white; border: none;">
                <i class="bi bi-check-circle me-2"></i>ƒê√£ Chuy·ªÉn Kho·∫£n - X√°c Nh·∫≠n Ngay
            </button>
            <form th:action="@{/payment/cancel/{id}(id=${invoice.id})}" method="post" id="cancelForm" style="display: inline;">
                <button type="button" class="btn btn-cancel btn-custom" onclick="confirmCancel()">
                    <i class="bi bi-x-circle me-2"></i>H·ªßy Thanh To√°n
                </button>
            </form>
        </div>
    </div>
</div>

<th:block th:replace="~{layout :: footer}"></th:block>

<script th:inline="javascript">
    const invoiceId = /*[[${invoice.id}]]*/ 0;
    let checkInterval;
    let checkCount = 0;
    const maxChecks = 120;

    function startChecking() {
        console.log('üîç Starting payment status checking for invoice #' + invoiceId);
        checkPaymentStatus();
        checkInterval = setInterval(checkPaymentStatus, 5000);
    }

    function checkPaymentStatus() {
        checkCount++;
        
        if (checkCount > maxChecks) {
            clearInterval(checkInterval);
            showTimeout();
            return;
        }

        fetch(`/payment/check/${invoiceId}`, {
            method: 'GET',
            credentials: 'same-origin',  // ‚≠ê G·ª≠i session cookie
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('üìä Payment status:', data);
                
                if (data.isPaid) {
                    clearInterval(checkInterval);
                    showSuccess(data.transactionCode);
                    setTimeout(() => {
                        window.location.href = '/invoices';
                    }, 3000);
                } else {
                    updateCheckingText();
                }
            })
            .catch(error => {
                console.error('‚ùå Error checking payment:', error);
                // Continue checking despite errors
            });
    }

    function updateCheckingText() {
        const dots = '.'.repeat((checkCount % 3) + 1);
        document.getElementById('checkingText').textContent = 
            `ƒêang ki·ªÉm tra giao d·ªãch${dots} (L·∫ßn ${checkCount})`;
    }

    function verifyManually() {
        const btn = document.getElementById('manualVerifyBtn');
        const originalHTML = btn.innerHTML;
        
        if (!confirm('‚ö†Ô∏è B·∫°n ƒë√£ chuy·ªÉn kho·∫£n CH√çNH X√ÅC theo th√¥ng tin tr√™n?\n\n‚úì S·ªë ti·ªÅn ƒë√∫ng\n‚úì N·ªôi dung chuy·ªÉn kho·∫£n ƒë√∫ng\n\nNh·∫•n OK ƒë·ªÉ x√°c nh·∫≠n thanh to√°n.')) {
            return;
        }
        
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ƒêang x√°c nh·∫≠n...';
        
        fetch(`/payment/verify-manual/${invoiceId}`, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.isPaid) {
                clearInterval(checkInterval);
                showSuccess(data.transactionCode);
                setTimeout(() => {
                    window.location.href = '/invoices';
                }, 3000);
            } else {
                alert('‚ùå ' + (data.message || 'Kh√¥ng th·ªÉ x√°c nh·∫≠n thanh to√°n'));
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        })
        .catch(error => {
            console.error('‚ùå Error in manual verification:', error);
            alert('‚ùå L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.');
            btn.disabled = false;
            btn.innerHTML = originalHTML;
        });
    }

    function showSuccess(transactionCode) {
        const statusSection = document.getElementById('statusSection');
        statusSection.className = 'status-section paid';
        statusSection.innerHTML = `
            <div class="status-icon">
                <i class="bi bi-check-circle-fill text-success"></i>
            </div>
            <div class="status-text text-success">
                <i class="bi bi-check2-circle me-2"></i>Thanh to√°n th√†nh c√¥ng!
            </div>
            <small class="text-muted d-block mt-2">
                M√£ giao d·ªãch: ${transactionCode}<br>
                ƒêang chuy·ªÉn h∆∞·ªõng v·ªÅ danh s√°ch ƒë∆°n h√†ng...
            </small>
        `;
        document.getElementById('actionButtons').style.display = 'none';
    }

    function showTimeout() {
        const statusSection = document.getElementById('statusSection');
        statusSection.innerHTML = `
            <div class="status-icon">
                <i class="bi bi-clock-history text-secondary"></i>
            </div>
            <div class="status-text text-secondary">
                <i class="bi bi-exclamation-triangle me-2"></i>H·∫øt th·ªùi gian ch·ªù
            </div>
            <small class="text-muted d-block mt-2">
                Vui l√≤ng ki·ªÉm tra l·∫°i tr·∫°ng th√°i ƒë∆°n h√†ng trong "ƒê∆°n H√†ng C·ªßa T√¥i"
            </small>
        `;
    }

    function confirmCancel() {
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy thanh to√°n? ƒê∆°n h√†ng s·∫Ω b·ªã h·ªßy.')) {
            clearInterval(checkInterval);
            document.getElementById('cancelForm').submit();
        }
    }

    function copyToClipboard(button, text) {
        navigator.clipboard.writeText(text).then(() => {
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="bi bi-check-circle-fill"></i> Copied!';
            button.classList.remove('btn-outline-primary', 'btn-outline-success', 'btn-danger');
            button.classList.add('btn-success');
            
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('btn-success');
                if (button.querySelector('.bi-clipboard-check')) {
                    button.classList.add('btn-danger');
                } else if (button.textContent.includes('Copy')) {
                    if (originalHTML.includes('cash')) {
                        button.classList.add('btn-outline-success');
                    } else {
                        button.classList.add('btn-outline-primary');
                    }
                }
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy:', err);
            alert('Kh√¥ng th·ªÉ copy. Vui l√≤ng copy th·ªß c√¥ng: ' + text);
        });
    }

    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            checkPaymentStatus();
        }
    });

    window.addEventListener('beforeunload', function() {
        if (checkInterval) {
            clearInterval(checkInterval);
        }
    });

    window.addEventListener('load', function() {
        startChecking();
    });
</script>
</body>
</html>
