<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <th:block th:replace="~{layout::link-css}"></th:block>
    <th:block th:replace="~{layout::custom-css}"></th:block>
    <th:block th:replace="~{layout::icons-and-fonts}"></th:block>
    <title>Ch·ªânh S·ª≠a S√°ch</title>
</head>
<body>
<th:block th:replace="~{layout::header}"></th:block>
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <h1 class="text-center mb-4"><i class="bi bi-pencil-square me-2"></i>Ch·ªânh S·ª≠a S√°ch</h1>
                    <form th:action="@{/books/edit}" th:object="${book}" method="post" enctype="multipart/form-data">
                        <input type="hidden" th:field="*{id}">
                        <input type="hidden" name="currentImageUrl" th:value="${book.imageUrl}">
                        <div class="mb-3">
                            <label class="form-label" for="title">
                                <i class="bi bi-book me-1"></i>T√™n S√°ch:
                            </label>
                            <input class="form-control" type="text" th:field="*{title}"
                                   id="title" required autofocus>
                            <span class="text-danger" th:if="${#fields.hasErrors('title')}"
                                  th:errors="*{title}"></span>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="author">
                                <i class="bi bi-person me-1"></i>T√°c Gi·∫£:
                            </label>
                            <input class="form-control" type="text" th:field="*{author}"
                                   id="author">
                            <span class="text-danger" th:if="${#fields.hasErrors('author')}"
                                  th:errors="*{author}"></span>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="price">
                                <i class="bi bi-currency-dollar me-1"></i>Gi√°:
                            </label>
                            <input class="form-control" type="text" th:field="*{price}"
                                   id="price">
                            <span class="text-danger" th:if="${#fields.hasErrors('price')}"
                                  th:errors="*{price}"></span>
                        </div>
                        <div class="mb-4">
                            <label class="form-label" for="category">
                                <i class="bi bi-tag me-1"></i>Danh M·ª•c: <span class="text-danger">*</span>
                            </label>
                            <select class="form-control" id="category" name="category.id">
                                <option value="">-- Ch·ªçn Danh M·ª•c --</option>
                                <option th:each="category : ${categories}"
                                        th:value="${category.getId()}"
                                        th:text="${category.getName()}"
                                        th:selected="${category.getId() == book.category.getId()}"></option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="form-label" for="stock">
                                <i class="bi bi-box-seam me-1"></i>S·ªë l∆∞·ª£ng trong kho:
                            </label>
                            <input class="form-control" type="number" 
                                   th:field="*{stock}" id="stock" 
                                   min="0" required>
                            <span class="text-danger" th:if="${#fields.hasErrors('stock')}"
                                  th:errors="*{stock}"></span>
                        </div>
                        
                        <!-- ========== PH·∫¶N H√åNH ·∫¢NH S√ÅCH (EDIT) ========== -->
                        <div class="mb-4">
                            <h5 class="mb-3"><i class="bi bi-image me-2"></i>H√¨nh ·∫¢nh S√°ch</h5>
                            
                            <!-- Hi·ªÉn th·ªã ·∫£nh hi·ªán t·∫°i -->
                            <div class="mb-3">
                                <p class="mb-2"><strong>·∫¢nh hi·ªán t·∫°i:</strong></p>
                                <img th:src="${book.imageUrl}" 
                                     class="img-thumbnail mb-2" 
                                     style="width: 150px; height: 200px; object-fit: cover;"
                                     alt="·∫¢nh hi·ªán t·∫°i">
                                <div class="text-muted small" th:if="${book.imageUrl != null and !book.imageUrl.isEmpty()}">
                                    <span th:if="${book.imageUrl.startsWith('http')}" class="text-info">üåê Link online</span>
                                    <span th:if="${book.imageUrl.startsWith('data:image')}" class="text-primary">üì∑ Data URI (base64)</span>
                                    <span th:if="${!book.imageUrl.startsWith('http') and !book.imageUrl.startsWith('data:image')}" class="text-success">üìÅ File upload</span>
                                    <br>
                                    <small th:if="${book.imageUrl.startsWith('data:image')}" class="text-truncate d-block" style="max-width: 300px;" 
                                           th:title="${book.imageUrl}">Base64 image data (click to see full)</small>
                                    <small th:unless="${book.imageUrl.startsWith('data:image')}" class="text-break" th:text="${book.imageUrl}"></small>
                                </div>
                            </div>
                            
                            <!-- Input Link ·∫¢nh M·ªõi (∆Øu ti√™n) -->
                            <div class="mb-3">
                                <label class="form-label" for="imageUrl">
                                    <i class="bi bi-link me-1"></i>Thay ƒë·ªïi b·∫±ng link ·∫£nh m·ªõi (∆Øu ti√™n):
                                </label>
                                <input class="form-control" type="url" 
                                       th:field="*{imageUrl}" id="imageUrl" 
                                       placeholder="https://example.com/new-image.jpg"
                                       oninput="handleImageUrlInputEdit()">
                                <div class="form-text">
                                    <strong>C√°ch 1:</strong> Nh·∫≠p link ·∫£nh m·ªõi ‚Üí h·ªá th·ªëng s·∫Ω d√πng link n√†y v√† x√≥a ·∫£nh upload c≈© (n·∫øu c√≥).
                                </div>
                            </div>
                            
                            <!-- Input File Upload M·ªõi (Fallback) -->
                            <div class="mb-3">
                                <label class="form-label" for="imageFile">
                                    <i class="bi bi-upload me-1"></i>Ho·∫∑c t·∫£i l√™n file ·∫£nh m·ªõi:
                                </label>
                                <input class="form-control" type="file" 
                                       id="imageFile" name="imageFile"
                                       accept="image/jpeg,image/jpg,image/png,image/gif"
                                       onchange="handleFileInputEdit(this)">
                                <div class="form-text">
                                    <strong>C√°ch 2:</strong> T·∫£i file m·ªõi ‚Üí thay th·∫ø ·∫£nh hi·ªán t·∫°i. ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng thay ƒë·ªïi.
                                </div>
                            </div>
                            
                            <!-- Preview ·∫¢nh M·ªõi -->
                            <div class="text-center">
                                <p class="mb-2"><strong>Xem tr∆∞·ªõc ·∫£nh m·ªõi:</strong></p>
                                <img id="imagePreview" th:src="${book.imageUrl}"
                                     class="img-thumbnail" 
                                     style="width: 200px; height: 250px; object-fit: cover;"
                                     alt="Preview ·∫£nh m·ªõi">
                                <div id="imageSource" class="text-muted mt-1">·∫¢nh hi·ªán t·∫°i (ch∆∞a thay ƒë·ªïi)</div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-save me-2"></i>C·∫≠p Nh·∫≠t
                            </button>
                            <a th:href="@{/books}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left me-2"></i>Quay L·∫°i Danh S√°ch
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<th:block th:replace="~{layout::footer}"></th:block>

<!-- JavaScript x·ª≠ l√Ω preview ·∫£nh cho Edit -->
<script>
    // L∆∞u ·∫£nh g·ªëc ƒë·ªÉ reset v·ªÅ
    const originalImageUrl = document.getElementById('imageUrl').value || '/images/books/default-book.svg';
    
    // X·ª≠ l√Ω khi nh·∫≠p link ·∫£nh m·ªõi
    function handleImageUrlInputEdit() {
        const imageUrlInput = document.getElementById('imageUrl');
        const imageFileInput = document.getElementById('imageFile');
        const preview = document.getElementById('imagePreview');
        const source = document.getElementById('imageSource');
        
        const newImageUrl = imageUrlInput.value.trim();
        
        if (newImageUrl && newImageUrl !== originalImageUrl) {
            // C√≥ link m·ªõi ‚Üí Preview theo link m·ªõi, clear file input
            preview.src = newImageUrl;
            
            // Check if it's a Data URI (base64)
            if (newImageUrl.startsWith('data:image/')) {
                source.textContent = 'Data URI (base64 image) - s·∫Ω thay th·∫ø ·∫£nh c≈©';
                source.className = 'text-primary mt-1 fw-bold';
            } else {
                source.textContent = 'Link ·∫£nh m·ªõi (s·∫Ω thay th·∫ø ·∫£nh c≈©)';
                source.className = 'text-success mt-1 fw-bold';
            }
            
            // Clear file input v√¨ link c√≥ ∆∞u ti√™n
            imageFileInput.value = '';
        } else if (newImageUrl === originalImageUrl) {
            // V·ªÅ ·∫£nh g·ªëc
            preview.src = originalImageUrl;
            source.textContent = '·∫¢nh hi·ªán t·∫°i (ch∆∞a thay ƒë·ªïi)';
            source.className = 'text-muted mt-1';
        } else {
            // Tr·ªëng ‚Üí V·ªÅ ·∫£nh g·ªëc
            preview.src = originalImageUrl;
            source.textContent = '·∫¢nh hi·ªán t·∫°i (ch∆∞a thay ƒë·ªïi)';
            source.className = 'text-muted mt-1';
        }
    }
    
    // X·ª≠ l√Ω khi ch·ªçn file m·ªõi
    function handleFileInputEdit(input) {
        const imageUrlInput = document.getElementById('imageUrl');
        const preview = document.getElementById('imagePreview');
        const source = document.getElementById('imageSource');
        
        // N·∫øu c√≥ link ·∫£nh m·ªõi th√¨ ∆∞u ti√™n link
        const newImageUrl = imageUrlInput.value.trim();
        if (newImageUrl && newImageUrl !== originalImageUrl) {
            alert('B·∫°n ƒë√£ nh·∫≠p link ·∫£nh m·ªõi! H·ªá th·ªëng s·∫Ω ∆∞u ti√™n d√πng link v√† b·ªè qua file upload.');
            input.value = ''; // Clear file
            return;
        }
        
        // Preview file n·∫øu kh√¥ng c√≥ link m·ªõi
        if (input.files && input.files[0]) {
            const file = input.files[0];
            
            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('File qu√° l·ªõn! T·ªëi ƒëa 5MB.');
                input.value = '';
                return;
            }
            
            // Preview file m·ªõi
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                source.textContent = 'File ·∫£nh m·ªõi (' + file.name + ') - s·∫Ω thay th·∫ø ·∫£nh c≈©';
                source.className = 'text-info mt-1 fw-bold';
            };
            reader.readAsDataURL(file);
            
            // Clear image URL ƒë·ªÉ kh√¥ng conflict
            imageUrlInput.value = '';
        } else {
            // Kh√¥ng c√≥ file ‚Üí V·ªÅ ·∫£nh g·ªëc
            preview.src = originalImageUrl;
            source.textContent = '·∫¢nh hi·ªán t·∫°i (ch∆∞a thay ƒë·ªïi)';
            source.className = 'text-muted mt-1';
        }
    }
    
    // X·ª≠ l√Ω l·ªói load ·∫£nh
    document.getElementById('imagePreview').onerror = function() {
        this.src = '/images/books/default-book.svg';
        document.getElementById('imageSource').textContent = 'Link kh√¥ng h·ª£p l·ªá - D√πng ·∫£nh m·∫∑c ƒë·ªãnh';
        document.getElementById('imageSource').className = 'text-warning mt-1';
    };
    
    // Reset n√∫t ƒë·ªÉ v·ªÅ ·∫£nh g·ªëc
    function resetImageToOriginal() {
        const imageUrlInput = document.getElementById('imageUrl');
        const imageFileInput = document.getElementById('imageFile');
        const preview = document.getElementById('imagePreview');
        const source = document.getElementById('imageSource');
        
        imageUrlInput.value = originalImageUrl;
        imageFileInput.value = '';
        preview.src = originalImageUrl;
        source.textContent = '·∫¢nh hi·ªán t·∫°i (ch∆∞a thay ƒë·ªïi)';
        source.className = 'text-muted mt-1';
    }
</script>

</body>
</html>