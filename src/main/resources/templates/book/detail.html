<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${book.title} + ' - Chi ti·∫øt s√°ch'"></title>
    <th:block th:replace="~{layout::link-css}"></th:block>
    <th:block th:replace="~{layout::custom-css}"></th:block>
    <th:block th:replace="~{layout::icons-and-fonts}"></th:block>
    <style>
        /* Star Rating Display */
        .star-rating { 
            color: #ddd; 
            font-size: 1.5em; 
            display: inline-block;
        }
        .star-rating .filled { 
            color: #ffc107; 
        }
        
        /* Star Rating Input */
        .star-input { 
            display: flex; 
            flex-direction: row-reverse; 
            justify-content: flex-end;
            gap: 5px;
        }
        .star-input input { 
            display: none; 
        }
        .star-input label { 
            font-size: 2em; 
            color: #ddd; 
            cursor: pointer;
            transition: color 0.2s;
        }
        .star-input input:checked ~ label,
        .star-input label:hover,
        .star-input label:hover ~ label { 
            color: #ffc107; 
        }
        
        .book-image {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
        }
        
        .review-card {
            transition: transform 0.2s;
        }
        
        .review-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .wishlist-btn-detail {
            padding: 10px 20px;
            border: 2px solid #dc3545;
            background: white;
            color: #dc3545;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1em;
        }
        .wishlist-btn-detail:hover {
            background: #dc3545;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }
        .wishlist-btn-detail.active {
            background: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
<th:block th:replace="~{layout::header}"></th:block>

<div class="container my-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a th:href="@{/}">Trang ch·ªß</a></li>
            <li class="breadcrumb-item"><a th:href="@{/books}">S√°ch</a></li>
            <li class="breadcrumb-item active" th:text="${book.title}"></li>
        </ol>
    </nav>

    <!-- Alert messages -->
    <div th:if="${message}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-2"></i><span th:text="${message}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-x-circle me-2"></i><span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Book Details -->
    <div class="row mb-5">
        <div class="col-md-4">
            <div class="text-center">
                <img th:src="${book.imageUrl}" 
                     class="img-fluid rounded shadow-lg book-detail-image"
                     style="max-height: 500px; width: 100%; object-fit: cover; cursor: pointer;"
                     th:alt="${book.title}"
                     onclick="showFullImageModal(this)">
                
                <!-- Th√¥ng tin ngu·ªìn ·∫£nh -->
                <div class="mt-2 text-muted small">
                    <span th:if="${book.imageUrl != null and book.imageUrl.startsWith('http')}" class="text-info">
                        üåê ·∫¢nh t·ª´ link online
                    </span>
                    <span th:if="${book.imageUrl != null and !book.imageUrl.startsWith('http') and !book.imageUrl.contains('default-book.jpg')}" class="text-success">
                        üìÅ ·∫¢nh t·∫£i l√™n
                    </span>
                    <span th:if="${book.imageUrl == null or book.imageUrl.contains('default-book.svg')}" class="text-secondary">
                        üñºÔ∏è ·∫¢nh m·∫∑c ƒë·ªãnh
                    </span>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <h2 class="mb-3" th:text="${book.title}"></h2>
            <p class="text-muted mb-2">
                <i class="bi bi-person me-2"></i>T√°c gi·∫£: <strong th:text="${book.author}"></strong>
            </p>
            <p class="mb-2">
                <i class="bi bi-tag me-2"></i>Danh m·ª•c: 
                <span class="badge bg-info" th:text="${book.category.name}"></span>
            </p>
            
            <!-- Rating display -->
            <div class="mb-3">
                <span class="star-rating">
                    <span th:each="i : ${#numbers.sequence(1, 5)}" 
                          th:classappend="${i <= book.averageRating} ? 'filled' : ''">‚òÖ</span>
                </span>
                <span class="ms-2">
                    <strong th:text="${#numbers.formatDecimal(book.averageRating, 1, 2)}">0.0</strong>
                    (<span th:text="${book.totalReviews}">0</span> ƒë√°nh gi√°)
                </span>
            </div>
            
            <h3 class="text-danger mb-3">
                <i class="bi bi-currency-dollar me-1"></i>
                <span th:text="${#numbers.formatDecimal(book.price, 0, 'COMMA', 0, 'POINT')}"></span> ƒë
            </h3>
            
            <!-- Stock info -->
            <div class="mb-3">
                <span th:if="${book.stock > 0}" class="badge bg-success fs-6">
                    <i class="bi bi-check-circle me-1"></i>
                    C√≤n <strong th:text="${book.stock}"></strong> quy·ªÉn
                </span>
                <span th:if="${book.stock == 0}" class="badge bg-danger fs-6">
                    <i class="bi bi-x-circle me-1"></i>H·∫øt h√†ng
                </span>
            </div>
            
            <!-- Add to cart form -->
            <form th:if="${book.stock > 0}" 
                  th:action="@{/books/add-to-cart}" 
                  method="post"
                  sec:authorize="isAuthenticated()">
                <input type="hidden" name="id" th:value="${book.id}">
                <input type="hidden" name="name" th:value="${book.title}">
                <input type="hidden" name="price" th:value="${book.price}">
                <div class="input-group mb-3" style="max-width: 400px;">
                    <input type="number" name="quantity" class="form-control" value="1" min="1" th:max="${book.stock}">
                    <button class="btn btn-primary" type="submit">
                        <i class="bi bi-cart-plus me-2"></i>Th√™m v√†o gi·ªè
                    </button>
                </div>
            </form>
            
            <!-- Wishlist button -->
            <button sec:authorize="isAuthenticated()"
                    class="wishlist-btn-detail wishlist-btn mb-3"
                    th:data-book-id="${book.id}"
                    onclick="toggleWishlist(this)">
                <span class="heart-icon">‚ô°</span>
                <span class="ms-2">Th√™m v√†o y√™u th√≠ch</span>
            </button>
            
            <div sec:authorize="!isAuthenticated()" class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                Vui l√≤ng <a th:href="@{/login}" class="alert-link">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ mua s√°ch
            </div>
        </div>
    </div>
    
    <hr class="my-5">
    
    <!-- Reviews Section -->
    <div class="row">
        <div class="col-md-12">
            <h3 class="mb-4">
                <i class="bi bi-chat-square-text me-2"></i>ƒê√°nh gi√° c·ªßa kh√°ch h√†ng
            </h3>
            
            <!-- Add review form (only if user can review) -->
            <div sec:authorize="isAuthenticated()" th:if="${canReview}" class="card mb-4 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-pencil-square me-2"></i>Vi·∫øt ƒë√°nh gi√° c·ªßa b·∫°n</h5>
                </div>
                <div class="card-body">
                    <form th:action="@{/reviews/add}" method="post">
                        <input type="hidden" name="bookId" th:value="${book.id}">
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">ƒê√°nh gi√°: <span class="text-danger">*</span></label>
                            <div class="star-input">
                                <input type="radio" name="rating" value="5" id="star5" required>
                                <label for="star5" title="Xu·∫•t s·∫Øc">‚òÖ</label>
                                <input type="radio" name="rating" value="4" id="star4">
                                <label for="star4" title="T·ªët">‚òÖ</label>
                                <input type="radio" name="rating" value="3" id="star3">
                                <label for="star3" title="Trung b√¨nh">‚òÖ</label>
                                <input type="radio" name="rating" value="2" id="star2">
                                <label for="star2" title="K√©m">‚òÖ</label>
                                <input type="radio" name="rating" value="1" id="star1">
                                <label for="star1" title="R·∫•t k√©m">‚òÖ</label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Nh·∫≠n x√©t: <span class="text-danger">*</span></label>
                            <textarea name="comment" class="form-control" rows="4" maxlength="1000" 
                                      placeholder="Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n v·ªÅ cu·ªën s√°ch n√†y..." required></textarea>
                            <small class="text-muted">T·ªëi ƒëa 1000 k√Ω t·ª±</small>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-send me-2"></i>G·ª≠i ƒë√°nh gi√°
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Message if user already reviewed -->
            <div sec:authorize="isAuthenticated()" th:if="${userReview != null}" class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                B·∫°n ƒë√£ ƒë√°nh gi√° s√°ch n√†y. 
                <a href="#" data-bs-toggle="modal" data-bs-target="#editReviewModal" class="alert-link">
                    Ch·ªânh s·ª≠a ƒë√°nh gi√°
                </a>
            </div>
            
            <!-- Message if user can't review -->
            <div sec:authorize="isAuthenticated()" th:if="${!canReview && userReview == null}" class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                B·∫°n c·∫ßn mua s√°ch n√†y ƒë·ªÉ c√≥ th·ªÉ ƒë√°nh gi√°.
            </div>
            
            <!-- List of reviews -->
            <div th:if="${#lists.isEmpty(reviews.content)}" class="alert alert-secondary text-center">
                <i class="bi bi-chat-square-dots me-2"></i>
                Ch∆∞a c√≥ ƒë√°nh gi√° n√†o cho s√°ch n√†y. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!
            </div>
            
            <div th:each="review : ${reviews.content}" class="card mb-3 review-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">
                                <i class="bi bi-person-circle me-2"></i>
                                <strong th:text="${review.user.username}"></strong>
                            </h6>
                            <div class="star-rating small mb-2">
                                <span th:each="i : ${#numbers.sequence(1, 5)}" 
                                      th:classappend="${i <= review.rating} ? 'filled' : ''">‚òÖ</span>
                            </div>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">
                                <i class="bi bi-calendar me-1"></i>
                                <span th:text="${#dates.format(review.reviewDate, 'dd/MM/yyyy HH:mm')}"></span>
                            </small>
                            <div sec:authorize="isAuthenticated()">
                                <!-- Delete button for owner or admin -->
                                <a th:if="${#authentication.principal.id == review.user.id} or ${#authorization.expression('hasAuthority(''ADMIN'')')}"
                                   th:href="@{/reviews/delete/{id}(id=${review.id}, bookId=${book.id})}"
                                   class="btn btn-sm btn-outline-danger mt-2"
                                   onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë√°nh gi√° n√†y?')">
                                    <i class="bi bi-trash me-1"></i>X√≥a
                                </a>
                            </div>
                        </div>
                    </div>
                    <p class="mt-2 mb-0" th:text="${review.comment}"></p>
                </div>
            </div>
            
            <!-- Pagination -->
            <nav th:if="${reviews.totalPages > 1}" class="mt-4">
                <ul class="pagination justify-content-center">
                    <li class="page-item" th:classappend="${reviews.first} ? 'disabled'">
                        <a class="page-link" th:href="@{/books/{id}(id=${book.id}, page=${reviews.number - 1})}">
                            <i class="bi bi-chevron-left"></i> Tr∆∞·ªõc
                        </a>
                    </li>
                    <li class="page-item" 
                        th:each="i : ${#numbers.sequence(0, reviews.totalPages - 1)}"
                        th:classappend="${i == reviews.number} ? 'active'">
                        <a class="page-link" th:href="@{/books/{id}(id=${book.id}, page=${i})}" th:text="${i + 1}"></a>
                    </li>
                    <li class="page-item" th:classappend="${reviews.last} ? 'disabled'">
                        <a class="page-link" th:href="@{/books/{id}(id=${book.id}, page=${reviews.number + 1})}">
                            Sau <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Edit Review Modal -->
<div sec:authorize="isAuthenticated()" th:if="${userReview != null}" 
     class="modal fade" id="editReviewModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ch·ªânh s·ª≠a ƒë√°nh gi√°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form th:action="@{/reviews/update/{id}(id=${userReview.id})}" method="post">
                <input type="hidden" name="bookId" th:value="${book.id}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">ƒê√°nh gi√°:</label>
                        <div class="star-input">
                            <input type="radio" name="rating" value="5" id="edit-star5" 
                                   th:checked="${userReview.rating == 5}">
                            <label for="edit-star5">‚òÖ</label>
                            <input type="radio" name="rating" value="4" id="edit-star4"
                                   th:checked="${userReview.rating == 4}">
                            <label for="edit-star4">‚òÖ</label>
                            <input type="radio" name="rating" value="3" id="edit-star3"
                                   th:checked="${userReview.rating == 3}">
                            <label for="edit-star3">‚òÖ</label>
                            <input type="radio" name="rating" value="2" id="edit-star2"
                                   th:checked="${userReview.rating == 2}">
                            <label for="edit-star2">‚òÖ</label>
                            <input type="radio" name="rating" value="1" id="edit-star1"
                                   th:checked="${userReview.rating == 1}">
                            <label for="edit-star1">‚òÖ</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Nh·∫≠n x√©t:</label>
                        <textarea name="comment" class="form-control" rows="4" 
                                  maxlength="1000" th:text="${userReview.comment}"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="submit" class="btn btn-primary">C·∫≠p nh·∫≠t</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal hi·ªÉn th·ªã ·∫£nh full size -->
<div class="modal fade" id="fullImageModal" tabindex="-1" aria-labelledby="fullImageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fullImageModalLabel">H√¨nh ·∫£nh s√°ch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-0">
                <img id="modalFullImage" src="" class="img-fluid" style="max-height: 80vh; width: auto;" alt="Book Full Image">
            </div>
            <div class="modal-footer">
                <div id="modalImageInfo" class="text-muted small me-auto"></div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

<th:block th:replace="~{layout::footer}"></th:block>

<!-- JavaScript cho image modal v√† x·ª≠ l√Ω l·ªói ·∫£nh -->
<script>
    // Hi·ªÉn th·ªã modal ·∫£nh full size
    function showFullImageModal(imgElement) {
        const modal = new bootstrap.Modal(document.getElementById('fullImageModal'));
        const modalImage = document.getElementById('modalFullImage');
        const modalTitle = document.getElementById('fullImageModalLabel');
        const modalInfo = document.getElementById('modalImageInfo');
        
        modalImage.src = imgElement.src;
        modalTitle.textContent = imgElement.alt || 'H√¨nh ·∫£nh s√°ch';
        
        // Hi·ªÉn th·ªã th√¥ng tin ·∫£nh
        if (imgElement.src.includes('http')) {
            modalInfo.textContent = 'üåê ·∫¢nh t·ª´ link online: ' + imgElement.src;
        } else if (imgElement.src.includes('default-book.svg')) {
            modalInfo.textContent = 'üñºÔ∏è ·∫¢nh m·∫∑c ƒë·ªãnh c·ªßa h·ªá th·ªëng';
        } else {
            modalInfo.textContent = 'üìÅ ·∫¢nh t·∫£i l√™n t·ª´ admin';
        }
        
        modal.show();
    }
    
    // X·ª≠ l√Ω l·ªói load ·∫£nh
    document.addEventListener('DOMContentLoaded', function() {
        const bookImage = document.querySelector('.book-detail-image');
        if (bookImage) {
            bookImage.onerror = function() {
                this.src = '/images/books/default-book.svg';
                this.style.opacity = '0.8';
                this.title = '·∫¢nh g·ªëc kh√¥ng t·∫£i ƒë∆∞·ª£c - Hi·ªÉn th·ªã ·∫£nh m·∫∑c ƒë·ªãnh';
                
                // C·∫≠p nh·∫≠t th√¥ng tin ngu·ªìn ·∫£nh
                const sourceInfo = this.parentElement.querySelector('.small');
                if (sourceInfo) {
                    sourceInfo.innerHTML = '<span class="text-warning">‚ö†Ô∏è ·∫¢nh g·ªëc l·ªói - D√πng ·∫£nh m·∫∑c ƒë·ªãnh</span>';
                }
            };
        }
    });
</script>

</body>
</html>
