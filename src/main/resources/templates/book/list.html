<!DOCTYPE html>
<html
        xmlns:th="http://www.thymeleaf.org"
        xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
        lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    
    <title>Danh Sách Sách - E-BOOKS</title>
    <th:block th:replace="~{layout::link-css}"></th:block>
    <th:block th:replace="~{layout::custom-css}"></th:block>
    <th:block th:replace="~{layout::icons-and-fonts}"></th:block>
    <style>
        /* Product Card Styling */
        .product-card {
            position: relative;
            height: 100%;
            transition: all 0.3s ease;
            border: 1px solid var(--gray-200);
        }
        
        .product-card:hover {
            border-color: var(--primary-color);
        }
        
        .product-image-wrapper {
            position: relative;
            overflow: hidden;
            padding-top: 133.33%; /* 3:4 aspect ratio */
            background-color: var(--gray-100);
        }
        
        .product-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .product-card:hover .product-image {
            transform: scale(1.05);
        }
        
        .product-wishlist-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            min-width: 36px;
            height: 36px;
            border-radius: 18px;
            background: white;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            padding: 0.5rem;
        }
        
        .product-wishlist-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            background-color: var(--primary-color);
        }
        
        .product-wishlist-btn i,
        .product-wishlist-btn .heart-icon {
            font-size: 1rem;
            color: var(--gray-500);
        }
        
        .product-wishlist-btn.active i,
        .product-wishlist-btn.active .heart-icon,
        .product-wishlist-btn:hover i,
        .product-wishlist-btn:hover .heart-icon {
            color: white;
        }
        
        .wishlist-text {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--gray-500);
        }
        
        .product-wishlist-btn:hover .wishlist-text {
            color: white;
        }
        
        @media (max-width: 992px) {
            .product-wishlist-btn {
                width: 36px;
                border-radius: 50%;
            }
        }
        
        .product-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: var(--accent-color);
            color: white;
            padding: 0.25rem 0.625rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 10;
        }
        
        .product-stock-badge {
            background-color: var(--success-color);
        }
        
        .product-card-body {
            padding: 1rem;
        }
        
        .product-category {
            font-size: 0.75rem;
            color: var(--primary-color);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        
        .product-title {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 0.5rem;
            line-height: 1.4;
            height: 2.8em;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .product-title a {
            color: var(--dark-color);
            text-decoration: none;
        }
        
        .product-title a:hover {
            color: var(--primary-color);
        }
        
        .product-author {
            font-size: 0.8125rem;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
        }
        
        .product-rating {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }
        
        .product-price-section {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        
        .product-price {
            font-size: 1.375rem;
            font-weight: 700;
            color: var(--accent-color);
        }
        
        .product-stock {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .stock-in {
            background-color: #D1FAE5;
            color: #065F46;
        }
        
        .stock-low {
            background-color: #FEF3C7;
            color: #92400E;
        }
        
        .stock-out {
            background-color: #FEE2E2;
            color: #991B1B;
        }
        
        .product-actions {
            display: grid;
            gap: 0.5rem;
        }
        
        .btn-add-to-cart {
            width: 100%;
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 0.625rem;
            font-weight: 600;
            font-size: 0.9375rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-add-to-cart:hover:not(:disabled) {
            background-color: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3);
        }
        
        .btn-add-to-cart:disabled {
            background-color: var(--gray-300);
            cursor: not-allowed;
        }
        
        .admin-actions {
            display: flex;
            gap: 0.375rem;
        }
        
        .admin-actions .btn {
            flex: 1;
            font-size: 0.8125rem;
            padding: 0.4rem 0.5rem;
        }
        
        /* Filter Sidebar */
        .filter-card {
            position: sticky;
            top: 120px;
        }
        
        .filter-header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 1.25rem;
            border-radius: 12px 12px 0 0;
            font-weight: 600;
        }
        
        .filter-body {
            padding: 1.25rem;
        }
        
        .filter-body .form-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        /* Results Header */
        .results-header {
            background: white;
            border-radius: 12px;
            padding: 1.25rem 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .results-count {
            font-size: 1rem;
            color: var(--gray-700);
        }
        
        .results-count strong {
            color: var(--primary-color);
            font-weight: 700;
        }
        
        .view-toggle {
            display: flex;
            gap: 0.5rem;
        }
        
        .view-toggle-btn {
            width: 36px;
            height: 36px;
            border: 2px solid var(--gray-300);
            background: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .view-toggle-btn.active,
        .view-toggle-btn:hover {
            border-color: var(--primary-color);
            background-color: var(--primary-color);
            color: white;
        }
        
        @media (max-width: 768px) {
            .product-price {
                font-size: 1.125rem;
            }
            
            .filter-card {
                position: static;
                margin-bottom: 1.5rem;
            }
        }
    </style>
</head>
<body>
<th:block th:replace="~{layout::header}"></th:block>

<div class="container-xxl my-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Trang chủ</a></li>
            <li class="breadcrumb-item active">Danh sách sách</li>
        </ol>
    </nav>
    
    <!-- Page Title -->
    <div class="page-header mb-4">
        <h1 class="page-title">
            <i class="bi bi-book me-2"></i>Danh Sách Sách
        </h1>
    </div>
    
    <div class="row">
        <!-- Sidebar Filter -->
        <div class="col-lg-3">
            <div class="card filter-card shadow-sm">
                <div class="filter-header">
                    <i class="bi bi-funnel me-2"></i>Bộ Lọc
                </div>
                <div class="filter-body">
                    <form action="/books/search" method="get" id="filterForm">
                        
                        <!-- Tìm kiếm -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-search me-1"></i>Tìm kiếm
                            </label>
                            <input type="text" name="keyword" class="form-control" 
                                   th:value="${searchDTO?.keyword}"
                                   placeholder="Tên sách, tác giả...">
                        </div>
                        
                        <!-- Danh mục -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-tag me-1"></i>Danh mục
                            </label>
                            <select name="categoryId" class="form-select">
                                <option value="">Tất cả danh mục</option>
                                <option th:each="cat : ${categories}" 
                                        th:value="${cat.id}"
                                        th:text="${cat.name}"
                                        th:selected="${searchDTO?.categoryId == cat.id}">
                                </option>
                            </select>
                        </div>
                        
                        <!-- Khoảng giá -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-currency-dollar me-1"></i>Khoảng giá
                            </label>
                            <div class="row g-2">
                                <div class="col-6">
                                    <input type="number" name="minPrice" class="form-control form-control-sm"
                                           th:value="${searchDTO?.minPrice}"
                                           placeholder="Từ">
                                </div>
                                <div class="col-6">
                                    <input type="number" name="maxPrice" class="form-control form-control-sm"
                                           th:value="${searchDTO?.maxPrice}"
                                           placeholder="Đến">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sắp xếp -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-sort-down me-1"></i>Sắp xếp theo
                            </label>
                            <select name="sortBy" class="form-select form-select-sm">
                                <option value="id" th:selected="${searchDTO?.sortBy == 'id' or searchDTO?.sortBy == null}">Mặc định</option>
                                <option value="title" th:selected="${searchDTO?.sortBy == 'title'}">Tên sách (A-Z)</option>
                                <option value="price" th:selected="${searchDTO?.sortBy == 'price'}">Giá</option>
                                <option value="author" th:selected="${searchDTO?.sortBy == 'author'}">Tác giả</option>
                                <option value="averageRating" th:selected="${searchDTO?.sortBy == 'averageRating'}">Đánh giá</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <select name="sortDirection" class="form-select form-select-sm">
                                <option value="asc" th:selected="${searchDTO?.sortDirection == 'asc' or searchDTO?.sortDirection == null}">Tăng dần</option>
                                <option value="desc" th:selected="${searchDTO?.sortDirection == 'desc'}">Giảm dần</option>
                            </select>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search me-1"></i>Tìm kiếm
                            </button>
                            <a href="/books" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-clockwise me-1"></i>Đặt lại
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Products Grid -->
        <div class="col-lg-9">
            <!-- Results Header -->
            <div class="results-header">
                <div class="results-count">
                    <span th:if="${totalItems != null}">
                        Tìm thấy <strong th:text="${totalItems}"></strong> kết quả
                    </span>
                </div>
            </div>
            
            <!-- Products Grid -->
            <div class="row g-3 g-md-4" id="book-grid">
                <div class="col-6 col-md-4 col-xl-3" th:each="book : ${books}">
                    <div class="card product-card">
                        <!-- Product Image -->
                        <div class="product-image-wrapper">
                            <a th:href="@{/books/{id}(id=${book.getId()})}">
                                <img th:src="${book.imageUrl}" 
                                     class="product-image" 
                                     th:alt="${book.title}"
                                     onerror="this.src='/images/books/default-book.svg'">
                            </a>
                            
                            <!-- Stock Badge -->
                            <div class="product-badge product-stock-badge" th:if="${book.stock > 0 && book.stock <= 10}">
                                <i class="bi bi-exclamation-triangle me-1"></i>Còn <span th:text="${book.stock}"></span>
                            </div>
                            
                            <!-- Wishlist Button -->
                            <button sec:authorize="hasAnyAuthority('ADMIN', 'USER')"
                                    class="product-wishlist-btn wishlist-btn"
                                    th:data-book-id="${book.getId()}"
                                    onclick="toggleWishlist(this)"
                                    title="Thêm vào yêu thích">
                                <i class="bi bi-heart heart-icon me-1"></i>
                                <span class="wishlist-text d-none d-lg-inline">Yêu thích</span>
                            </button>
                        </div>
                        
                        <!-- Product Info -->
                        <div class="product-card-body">
                            <!-- Category -->
                            <div class="product-category" th:text="${book.getCategory().getName()}"></div>
                            
                            <!-- Title -->
                            <h3 class="product-title">
                                <a th:href="@{/books/{id}(id=${book.getId()})}" 
                                   th:text="${book.getTitle()}"></a>
                            </h3>
                            
                            <!-- Author -->
                            <div class="product-author">
                                <i class="bi bi-person me-1"></i>
                                <span th:text="${book.getAuthor()}"></span>
                            </div>
                            
                            <!-- Rating -->
                            <div class="product-rating">
                                <div class="star-rating">
                                    <span th:each="i : ${#numbers.sequence(1, 5)}" 
                                          th:classappend="${i <= book.averageRating} ? 'filled' : ''">★</span>
                                </div>
                                <span class="text-muted">
                                    (<span th:text="${book.totalReviews}">0</span>)
                                </span>
                            </div>
                            
                            <!-- Price & Stock -->
                            <div class="product-price-section">
                                <div class="product-price">
                                    <span th:text="${#numbers.formatDecimal(book.getPrice(), 0, 'COMMA', 0, 'POINT')}"></span>đ
                                </div>
                                <div>
                                    <span th:if="${book.stock > 10}" class="product-stock stock-in">
                                        Còn hàng
                                    </span>
                                    <span th:if="${book.stock <= 10 && book.stock > 0}" class="product-stock stock-low">
                                        Sắp hết
                                    </span>
                                    <span th:if="${book.stock == 0}" class="product-stock stock-out">
                                        Hết hàng
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Actions -->
                            <div class="product-actions" sec:authorize="hasAnyAuthority('ADMIN', 'USER')">
                                <!-- Add to Cart -->
                                <form th:action="@{/books/add-to-cart}" method="post">
                                    <input type="hidden" name="id" th:value="${book.getId()}">
                                    <input type="hidden" name="name" th:value="${book.getTitle()}">
                                    <input type="hidden" name="price" th:value="${book.getPrice()}">
                                    <button type="submit" class="btn-add-to-cart"
                                            th:disabled="${book.stock == 0}">
                                        <i class="bi bi-cart-plus me-1"></i>
                                        <span th:text="${book.stock == 0} ? 'Hết hàng' : 'Thêm vào giỏ'"></span>
                                    </button>
                                </form>
                                
                                <!-- Admin Actions -->
                                <div class="admin-actions" sec:authorize="hasAnyAuthority('ADMIN')">
                                    <a class="btn btn-primary btn-sm"
                                       th:href="@{/books/edit/{id}(id=${book.getId()})}"
                                       title="Chỉnh sửa sách">
                                        <i class="bi bi-pencil-square me-1"></i>Sửa
                                    </a>
                                    <button class="btn btn-danger btn-sm"
                                            th:onclick="'apiDeleteBook(' + ${book.getId()} + '); return false;'"
                                            title="Xóa sách">
                                        <i class="bi bi-trash3 me-1"></i>Xóa
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                        
            </div>
            
            <!-- Pagination -->
            <nav aria-label="Phân trang" th:if="${totalPages > 0}" class="mt-4">
                <ul class="pagination justify-content-center">
                    <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                        <a class="page-link" 
                           th:href="@{/books/search(page=${currentPage - 1}, size=20, keyword=${searchDTO?.keyword}, categoryId=${searchDTO?.categoryId}, minPrice=${searchDTO?.minPrice}, maxPrice=${searchDTO?.maxPrice}, sortBy=${searchDTO?.sortBy}, sortDirection=${searchDTO?.sortDirection})}">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                    
                    <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                        th:classappend="${currentPage == i} ? 'active'">
                        <a class="page-link" 
                           th:href="@{/books/search(page=${i}, size=20, keyword=${searchDTO?.keyword}, categoryId=${searchDTO?.categoryId}, minPrice=${searchDTO?.minPrice}, maxPrice=${searchDTO?.maxPrice}, sortBy=${searchDTO?.sortBy}, sortDirection=${searchDTO?.sortDirection})}"
                           th:text="${i + 1}"></a>
                    </li>
                    
                    <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                        <a class="page-link" 
                           th:href="@{/books/search(page=${currentPage + 1}, size=20, keyword=${searchDTO?.keyword}, categoryId=${searchDTO?.categoryId}, minPrice=${searchDTO?.minPrice}, maxPrice=${searchDTO?.maxPrice}, sortBy=${searchDTO?.sortBy}, sortDirection=${searchDTO?.sortDirection})}">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<th:block th:replace="~{layout::footer}"></th:block>

<script th:src="@{/js/list.js}"></script>
<script th:src="@{/js/filter.js}"></script>
</body>
</html>