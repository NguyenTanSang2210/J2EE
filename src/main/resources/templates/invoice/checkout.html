<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh To√°n</title>
    <th:block th:replace="~{layout::link-css}"></th:block>
    <th:block th:replace="~{layout::custom-css}"></th:block>
</head>
<body>
<th:block th:replace="~{layout::header}"></th:block>
<div class="container my-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="bi bi-credit-card me-2"></i>Thanh To√°n ƒê∆°n H√†ng</h1>
        </div>
    </div>
    
    <!-- Alert messages -->
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
        <i class="bi bi-exclamation-triangle me-2"></i><span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    
    <div class="row">
        <!-- Th√¥ng tin gi·ªè h√†ng -->
        <div class="col-md-5">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-cart3 me-2"></i>Gi·ªè H√†ng C·ªßa B·∫°n</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>S√°ch</th>
                                    <th class="text-center">SL</th>
                                    <th class="text-end">Gi√°</th>
                                    <th class="text-end">T·ªïng</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="item : ${cart.cartItems}">
                                    <td>
                                        <strong th:text="${item.bookName}"></strong>
                                    </td>
                                    <td class="text-center" th:text="${item.quantity}"></td>
                                    <td class="text-end">
                                        <span th:text="${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')}"></span> ƒë
                                    </td>
                                    <td class="text-end">
                                        <span th:text="${#numbers.formatDecimal(item.price * item.quantity, 0, 'COMMA', 0, 'POINT')}"></span> ƒë
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr class="table-primary">
                                    <th colspan="3">T·ªïng C·ªông:</th>
                                    <th class="text-end">
                                        <span class="fs-5 text-danger" 
                                              th:text="${#numbers.formatDecimal(totalPrice, 0, 'COMMA', 0, 'POINT')} + ' ƒë'"></span>
                                    </th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Form th√¥ng tin giao h√†ng -->
        <div class="col-md-7">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-truck me-2"></i>Th√¥ng Tin Giao H√†ng</h5>
                </div>
                <div class="card-body">
                    <form action="/cart/checkout" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        
                        <div class="row">
                            <!-- H·ªç v√† t√™n ng∆∞·ªùi nh·∫≠n -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="bi bi-person me-1"></i>H·ªç v√† t√™n ng∆∞·ªùi nh·∫≠n <span class="text-danger">*</span>
                                </label>
                                <input type="text" name="receiverName" class="form-control" 
                                       th:value="${currentUser?.username}"
                                       placeholder="Nh·∫≠p h·ªç t√™n ng∆∞·ªùi nh·∫≠n" 
                                       required maxlength="100">
                            </div>
                            
                            <!-- S·ªë ƒëi·ªán tho·∫°i -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="bi bi-telephone me-1"></i>S·ªë ƒëi·ªán tho·∫°i <span class="text-danger">*</span>
                                </label>
                                <input type="tel" name="phone" class="form-control" 
                                       th:value="${currentUser?.phone}"
                                       placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" 
                                       required maxlength="15"
                                       pattern="[0-9]{10,11}">
                                <small class="text-muted">V√≠ d·ª•: 0912345678</small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <!-- Email t√†i kho·∫£n (readonly - d√πng ƒë·ªÉ link user) -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="bi bi-shield-check me-1"></i>Email t√†i kho·∫£n <span class="text-danger">*</span>
                                </label>
                                <input type="email" name="accountEmail" class="form-control" 
                                       th:value="${currentUser?.email}"
                                       readonly
                                       style="background-color: #e9ecef; cursor: not-allowed;"
                                       required>
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> Email t√†i kho·∫£n (kh√¥ng th·ªÉ thay ƒë·ªïi)
                                </small>
                            </div>
                            
                            <!-- Email ng∆∞·ªùi nh·∫≠n (optional) -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="bi bi-envelope me-1"></i>Email ng∆∞·ªùi nh·∫≠n
                                </label>
                                <input type="email" name="receiverEmail" class="form-control" 
                                       th:value="${currentUser?.email}"
                                       placeholder="Email nh·∫≠n th√¥ng b√°o giao h√†ng"
                                       maxlength="100">
                                <small class="text-muted">ƒê·ªÉ tr·ªëng n·∫øu d√πng email t√†i kho·∫£n</small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <!-- Ph∆∞∆°ng th·ª©c thanh to√°n -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="bi bi-credit-card me-1"></i>Ph∆∞∆°ng th·ª©c thanh to√°n <span class="text-danger">*</span>
                                </label>
                                <select name="paymentMethod" class="form-select" required>
                                    <option value="">-- Ch·ªçn ph∆∞∆°ng th·ª©c --</option>
                                    <option value="COD">üíµ Thanh to√°n khi nh·∫≠n h√†ng (COD)</option>
                                    <option value="BANK_TRANSFER">üè¶ Chuy·ªÉn kho·∫£n ng√¢n h√†ng (QR Code)</option>
                                    <option value="CREDIT_CARD" disabled>üí≥ Th·∫ª t√≠n d·ª•ng (S·∫Øp ra m·∫Øt)</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- ƒê·ªãa ch·ªâ giao h√†ng -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-geo-alt me-1"></i>ƒê·ªãa ch·ªâ giao h√†ng <span class="text-danger">*</span>
                            </label>
                            <textarea name="shippingAddress" class="form-control" rows="3" 
                                      placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ chi ti·∫øt (S·ªë nh√†, t√™n ƒë∆∞·ªùng, ph∆∞·ªùng/x√£, qu·∫≠n/huy·ªán, t·ªânh/th√†nh ph·ªë)" 
                                      required maxlength="500"></textarea>
                            <small class="text-muted">Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß v√† ch√≠nh x√°c ƒë·ªÉ ƒë·∫£m b·∫£o giao h√†ng nhanh ch√≥ng</small>
                        </div>
                        
                        <!-- Ghi ch√∫ -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="bi bi-pencil me-1"></i>Ghi ch√∫ (kh√¥ng b·∫Øt bu·ªôc)
                            </label>
                            <textarea name="note" class="form-control" rows="3" 
                                      placeholder="Ghi ch√∫ th√™m cho ƒë∆°n h√†ng..." 
                                      maxlength="1000"></textarea>
                        </div>
                        
                        <!-- Buttons -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-check-circle me-2"></i>ƒê·∫∑t H√†ng
                            </button>
                            <a href="/cart" class="btn btn-secondary">
                                <i class="bi bi-arrow-left me-2"></i>Quay L·∫°i Gi·ªè H√†ng
                            </a>
                        </div>
                        
                        <!-- Th√¥ng tin thanh to√°n chuy·ªÉn kho·∫£n -->
                        <div class="alert alert-info mt-4" id="bankingInfo" style="display:none;">
                            <h6><i class="bi bi-info-circle me-2"></i>Th√¥ng Tin Chuy·ªÉn Kho·∫£n:</h6>
                            <ul class="mb-0">
                                <li>Ng√¢n h√†ng: <strong>Vietcombank</strong></li>
                                <li>S·ªë t√†i kho·∫£n: <strong>0123456789</strong></li>
                                <li>Ch·ªß t√†i kho·∫£n: <strong>CONG TY QLS</strong></li>
                                <li>N·ªôi dung: <strong>THANHTOAN [H·ªç t√™n] [S·ªë ƒëi·ªán tho·∫°i]</strong></li>
                            </ul>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block th:replace="~{layout::footer}"></th:block>

<script>
// Show banking info when payment method is BANKING
document.querySelector('select[name="paymentMethod"]')?.addEventListener('change', function() {
    const bankingInfo = document.getElementById('bankingInfo');
    if (this.value === 'BANKING') {
        bankingInfo.style.display = 'block';
    } else {
        bankingInfo.style.display = 'none';
    }
});

// Form validation
document.querySelector('form')?.addEventListener('submit', function(e) {
    const phone = document.querySelector('input[name="phone"]').value;
    const phonePattern = /^[0-9]{10,11}$/;
    
    if (!phonePattern.test(phone)) {
        e.preventDefault();
        alert('S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá! Vui l√≤ng nh·∫≠p 10-11 s·ªë.');
        return false;
    }
    
    return confirm('X√°c nh·∫≠n ƒë·∫∑t h√†ng?');
});
</script>
</body>
</html>
